# Directive for creating a script for your notebook


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

# Libraries

Include all the libraries which should be used in this module. You can
also import modules from other notebooks; here, we have imported the
functions in the core notebook.

``` python
# This block should never be exported. It is to have python running in the project (and not the nbs) dir, and to initiate the package using pip.
os.chdir(core.PROJECT_DIR)
```

# Functions

Add your code here below. If your notebook will be used as a
console-script, you need to add a “cli”-function, at the end (see
[Coding in
NBdev](https://dksund.sharepoint.com/:fl:/g/contentstorage/CSP_7c761ee7-b577-4e08-8517-bc82392bf65e/ETlSfUyArSNJhX8veMI_JQ8By1aXGHzDJkhotpfpXx4mmw?e=037EwH&nav=cz0lMkZjb250ZW50c3RvcmFnZSUyRkNTUF83Yzc2MWVlNy1iNTc3LTRlMDgtODUxNy1iYzgyMzkyYmY2NWUmZD1iJTIxNXg1MmZIZTFDRTZGRjd5Q09TdjJYblkwVlNiWXFYcE1yaHVrVmZqTVJUVEE4X1VwZjhTd1JxcjRNdmFrSmh2RCZmPTAxVlVLVzVWSlpLSjZVWkFGTkVORVlLN1pQUERCRDZKSVAmYz0lMkYmYT1Mb29wQXBwJnA9JTQwZmx1aWR4JTJGbG9vcC1wYWdlLWNvbnRhaW5lciZ4PSU3QiUyMnclMjIlM0ElMjJUMFJUVUh4a2EzTjFibVF1YzJoaGNtVndiMmx1ZEM1amIyMThZaUUxZURVeVpraGxNVU5GTmtaR04zbERUMU4yTWxodVdUQldVMkpaY1Zod1RYSm9kV3RXWm1wTlVsUlVRVGhmVlhCbU9GTjNVbkZ5TkUxMllXdEthSFpFZkRBeFZsVkxWelZXU1RJMVJsaFBNalkyUlZkQ1FqTTFRVmhKVTBkRFVVcFdXa1klM0QlMjIlMkMlMjJpJTIyJTNBJTIyNzRmNzM1ZmUtYzg4Ny00MjhhLWFkZmYtNTEyZTg2YmNmZmQzJTIyJTdE)
(**Code execution** and **Input, output and options**) on loop for more
details)

------------------------------------------------------------------------

<a
href="https://github.com/thej-ssi/ssi_analysis_result_parsers/blob/main/ssi_analysis_result_parsers/blast_parser.py#L111"
target="_blank" style="float:right; font-size:smaller">source</a>

### extract_allele_matches

>  extract_allele_matches (blast_output_tsv:pathlib.Path, tsv_header:str,
>                              include_match_stats=False)

*Parse blast output tsv for best matching alleles returns: if
include_match stats: { <gene_name_1>: <allele_number>**<pident>**<plen>,
<gene_name_2>: <allele_number>**<pident>**<plen>, <gene_name_3>:
<allele_number>**<pident>**<plen> …} else: a dictionary (allele_dict) in
the format { <gene_name_1>: <allele_number>, <gene_name_2>:
<allele_number>, <gene_name_3>: <allele_number> …}*

------------------------------------------------------------------------

<a
href="https://github.com/thej-ssi/ssi_analysis_result_parsers/blob/main/ssi_analysis_result_parsers/blast_parser.py#L33"
target="_blank" style="float:right; font-size:smaller">source</a>

### extract_presence_absence

>  extract_presence_absence (blast_output_tsv:pathlib.Path,
>                                tsv_header:str='qseqid sseqid pident length
>                                qlen qstart qend sstart send sseq evalue
>                                bitscore', hits_as_string:bool=True,
>                                include_match_stats=False,
>                                pident_threshold:float=90,
>                                plen_threshold:float=60, gene_names:list=None)

*Parse blast output tsv for best matching alleles returns: if
include_match stats: { <gene_name_1>: <allele_number>, <gene_name_2>:
<allele_number>, <gene_name_3>: <allele_number> …} else: a dictionary
(allele_dict) in the format { <gene_name_1>: <allele_number>,
<gene_name_2>: <allele_number>, <gene_name_3>: <allele_number> …}*

## TESTING

``` python
gene_presence_dict = extract_presence_absence(blast_output_tsv="./test_input/blast_parser/gene_presence_absence_test.tsv",
                                     tsv_header="qseqid sseqid pident length qlen qstart qend sstart send sseq evalue bitscore",
                                     include_match_stats=False,
                                     hits_as_string=True
                                     )
assert(len(gene_presence_dict) == 1)
assert(gene_presence_dict["genes_found"] == "asd, proA")


gene_presence_dict = extract_presence_absence(blast_output_tsv="./test_input/blast_parser/gene_presence_absence_test.tsv",
                                     tsv_header="qseqid sseqid pident length qlen qstart qend sstart send sseq evalue bitscore",
                                     include_match_stats=True,
                                     hits_as_string=True,
                                     )
assert(gene_presence_dict["genes_found"] == "asd__98.732__100.0, proA__97.284__100.0")


gene_presence_dict = extract_presence_absence(blast_output_tsv="./test_input/blast_parser/gene_presence_absence_test.tsv",
                                     tsv_header="qseqid sseqid pident length qlen qstart qend sstart send sseq evalue bitscore",
                                     include_match_stats=True,
                                     hits_as_string=True,
                                     pident_threshold=80,
                                     )
assert(gene_presence_dict["genes_found"] == "asd__98.732__100.0, pilE__82.835__100.0, proA__97.284__100.0")


gene_presence_dict = extract_presence_absence(blast_output_tsv="./test_input/blast_parser/gene_presence_absence_test.tsv",
                                     tsv_header="qseqid sseqid pident length qlen qstart qend sstart send sseq evalue bitscore",
                                     include_match_stats=False,
                                     hits_as_string=False,
                                     gene_names = ["asd","proA","pilE"])
assert(gene_presence_dict["asd"] == "1")
assert(gene_presence_dict["proA"] == "1")
assert(gene_presence_dict["pilE"] == "0")


gene_presence_dict = extract_presence_absence(blast_output_tsv="./test_input/blast_parser/gene_presence_absence_test.tsv",
                                     tsv_header="qseqid sseqid pident length qlen qstart qend sstart send sseq evalue bitscore",
                                     include_match_stats=True,
                                     hits_as_string=False,
                                     gene_names = ["asd","proA","pilE"])

assert(gene_presence_dict["asd"] == "98.732__100.0")
assert(gene_presence_dict["proA"] == "97.284__100.0")
assert(gene_presence_dict["pilE"] == "0")


gene_presence_dict = extract_presence_absence(blast_output_tsv="./test_input/blast_parser/empty_gene_presence_absense_test.tsv",
                                     tsv_header="qseqid sseqid pident length qlen qstart qend sstart send sseq evalue bitscore",
                                     include_match_stats=False,
                                     hits_as_string=False,
                                     gene_names=["lag-1"]
                                     )
assert(gene_presence_dict["lag-1"] == "0")


gene_presence_dict = extract_presence_absence(blast_output_tsv="./test_input/empty_file.txt",
                                     tsv_header="qseqid sseqid pident length qlen qstart qend sstart send sseq evalue bitscore",
                                     include_match_stats=False,
                                     hits_as_string=False,
                                     gene_names=["lag-1"]
                                     )
assert(gene_presence_dict["lag-1"] == "0")


gene_presence_dict = extract_presence_absence(blast_output_tsv="./test_input/empty_file.txt",
                                     tsv_header="qseqid sseqid pident length qlen qstart qend sstart send sseq evalue bitscore",
                                     include_match_stats=True,
                                     hits_as_string=False,
                                     gene_names=["lag-1"]
                                     )
assert(gene_presence_dict["lag-1"] == "0")


gene_presence_dict = extract_presence_absence(blast_output_tsv="./test_input/empty_file.txt",
                                     tsv_header="qseqid sseqid pident length qlen qstart qend sstart send sseq evalue bitscore",
                                     include_match_stats=False,
                                     hits_as_string=True,
                                     gene_names=["lag-1"]
                                     )
assert(gene_presence_dict["genes_found"] == "")


gene_presence_dict = extract_presence_absence(blast_output_tsv="./test_input/empty_file.txt",
                                     tsv_header="qseqid sseqid pident length qlen qstart qend sstart send sseq evalue bitscore",
                                     include_match_stats=True,
                                     hits_as_string=True
                                     )
assert(gene_presence_dict["genes_found"] == "")


# Test for missing file handling (should return None)
gene_presence_dict = extract_presence_absence(blast_output_tsv="./test_input/file/that/does/not/exist.tsv",
                                     tsv_header="qseqid sseqid pident length qlen qstart qend sstart send sseq evalue bitscore",
                                     include_match_stats=True,
                                     hits_as_string=True,
                                     gene_names=["lag-1"]
                                     )
assert(gene_presence_dict is None)

# Check for incorrect number of columns handling (should return None)
gene_presence_dict = extract_presence_absence(blast_output_tsv="./test_input/Legionella/test.sbt.tsv",
                                     tsv_header="qseqid sseqid pident length qlen qstart qend sstart send sseq evalue bitscore",
                                     include_match_stats=True,
                                     hits_as_string=True,
                                     gene_names=["lag-1"]
                                     )
assert(gene_presence_dict is None)


allele_dict = extract_allele_matches(blast_output_tsv="./test_input/blast_parser/allele_matches_test.tsv",
                                     tsv_header="qseqid sseqid pident length qlen qstart qend sstart send sseq evalue bitscore")

detailed_allele_dict = extract_allele_matches(blast_output_tsv="./test_input/blast_parser/allele_matches_test.tsv",
                                     tsv_header="qseqid sseqid pident length qlen qstart qend sstart send sseq evalue bitscore",
                                     include_match_stats=True)

assert(len(allele_dict) == 7)
assert(allele_dict['asd'] == "9")
assert(detailed_allele_dict['pilE'] == "3__100.0__100.0")


# Test for missing file handling (should return None)
allele_dict = extract_allele_matches(blast_output_tsv="./test_input/file/that/does/not/exist.tsv",
                                            tsv_header="qseqid sseqid pident length qlen qstart qend sstart send sseq evalue bitscore",
                                            include_match_stats=True)
assert(allele_dict is None)


# Test for incorrect number of columns handling (should return None)
allele_dict = extract_allele_matches(blast_output_tsv="./test_input/Legionella/test.sbt.tsv",
                                            tsv_header="qseqid sseqid pident length qlen qstart qend sstart send sseq evalue bitscore",
                                            include_match_stats=True)
assert(allele_dict is None)
```

    Blast output file ./test_input/blast_parser/empty_gene_presence_absense_test.tsv empty. Assuming 0 blast hits.
    Blast output file ./test_input/empty_file.txt empty. Assuming 0 blast hits.
    Blast output file ./test_input/empty_file.txt empty. Assuming 0 blast hits.
    Blast output file ./test_input/empty_file.txt empty. Assuming 0 blast hits.
    Blast output file ./test_input/empty_file.txt empty. Assuming 0 blast hits.

    No blast output found at ./test_input/file/that/does/not/exist.tsv
    Failed to parse ./test_input/Legionella/test.sbt.tsv. Number of columns do not match length of provided header string
    No blast output found at ./test_input/file/that/does/not/exist.tsv
    Failed to parse ./test_input/Legionella/test.sbt.tsv. Number of columns do not match length of provided header string

------------------------------------------------------------------------

<a
href="https://github.com/thej-ssi/ssi_analysis_result_parsers/blob/main/ssi_analysis_result_parsers/blast_parser.py#L194"
target="_blank" style="float:right; font-size:smaller">source</a>

### allele_matches

>  allele_matches (blast_output:pathlib.Path=None,
>                      blast_tsv_header:str='qseqid sseqid pident length qlen
>                      qstart qend sstart send sseq evalue bitscore',
>                      include_match_stats:bool=False,
>                      output_file:pathlib.Path=None, config_file:str=None)

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>blast_output</td>
<td>Path</td>
<td>None</td>
<td>Path to blast output file. Generated with –outfmt 6 option</td>
</tr>
<tr>
<td>blast_tsv_header</td>
<td>str</td>
<td>qseqid sseqid pident length qlen qstart qend sstart send sseq evalue
bitscore</td>
<td>headers in blast output</td>
</tr>
<tr>
<td>include_match_stats</td>
<td>bool</td>
<td>False</td>
<td>True to include percent identity and percent length in output, false
to only include allele number</td>
</tr>
<tr>
<td>output_file</td>
<td>Path</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>config_file</td>
<td>str</td>
<td>None</td>
<td>config file to set env vars from</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>None</strong></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

------------------------------------------------------------------------

<a
href="https://github.com/thej-ssi/ssi_analysis_result_parsers/blob/main/ssi_analysis_result_parsers/blast_parser.py#L169"
target="_blank" style="float:right; font-size:smaller">source</a>

### presence_absence

>  presence_absence (blast_output:pathlib.Path=None,
>                        blast_tsv_header:str='qseqid sseqid pident length qlen
>                        qstart qend sstart send sseq evalue bitscore',
>                        hits_as_string:bool=True,
>                        include_match_stats:bool=False,
>                        percent_identityt:float=90, percent_length:float=60,
>                        gene_names:list=None, output_file:pathlib.Path=None,
>                        config_file:str=None)

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>blast_output</td>
<td>Path</td>
<td>None</td>
<td>Path to blast output file. Generated with –outfmt 6 option</td>
</tr>
<tr>
<td>blast_tsv_header</td>
<td>str</td>
<td>qseqid sseqid pident length qlen qstart qend sstart send sseq evalue
bitscore</td>
<td>headers in blast output</td>
</tr>
<tr>
<td>hits_as_string</td>
<td>bool</td>
<td>True</td>
<td>True to print a comma separated list of found genes on a single
line. False to return a key: value pair for each gene</td>
</tr>
<tr>
<td>include_match_stats</td>
<td>bool</td>
<td>False</td>
<td>True to include percent identity and percent length in output, false
to only include present/absent</td>
</tr>
<tr>
<td>percent_identityt</td>
<td>float</td>
<td>90</td>
<td>percent identity threshold for considering a gene present</td>
</tr>
<tr>
<td>percent_length</td>
<td>float</td>
<td>60</td>
<td>percent length threshold for considering a gene present</td>
</tr>
<tr>
<td>gene_names</td>
<td>list</td>
<td>None</td>
<td>name of genes to look for when hits_as_string = False</td>
</tr>
<tr>
<td>output_file</td>
<td>Path</td>
<td>None</td>
<td></td>
</tr>
<tr>
<td>config_file</td>
<td>str</td>
<td>None</td>
<td>config file to set env vars from</td>
</tr>
<tr>
<td><strong>Returns</strong></td>
<td><strong>None</strong></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

# Directive for ensuring that the code in your notebook get executed as a script

The code-block here below is required to ensure that the code in the
notebook is also transferred to the module (script), otherwise it will
just be a notebook. See [Coding in
NBdev](https://dksund.sharepoint.com/:fl:/g/contentstorage/CSP_7c761ee7-b577-4e08-8517-bc82392bf65e/ETlSfUyArSNJhX8veMI_JQ8By1aXGHzDJkhotpfpXx4mmw?e=037EwH&nav=cz0lMkZjb250ZW50c3RvcmFnZSUyRkNTUF83Yzc2MWVlNy1iNTc3LTRlMDgtODUxNy1iYzgyMzkyYmY2NWUmZD1iJTIxNXg1MmZIZTFDRTZGRjd5Q09TdjJYblkwVlNiWXFYcE1yaHVrVmZqTVJUVEE4X1VwZjhTd1JxcjRNdmFrSmh2RCZmPTAxVlVLVzVWSlpLSjZVWkFGTkVORVlLN1pQUERCRDZKSVAmYz0lMkYmYT1Mb29wQXBwJnA9JTQwZmx1aWR4JTJGbG9vcC1wYWdlLWNvbnRhaW5lciZ4PSU3QiUyMnclMjIlM0ElMjJUMFJUVUh4a2EzTjFibVF1YzJoaGNtVndiMmx1ZEM1amIyMThZaUUxZURVeVpraGxNVU5GTmtaR04zbERUMU4yTWxodVdUQldVMkpaY1Zod1RYSm9kV3RXWm1wTlVsUlVRVGhmVlhCbU9GTjNVbkZ5TkUxMllXdEthSFpFZkRBeFZsVkxWelZXU1RJMVJsaFBNalkyUlZkQ1FqTTFRVmhKVTBkRFVVcFdXa1klM0QlMjIlMkMlMjJpJTIyJTNBJTIyNzRmNzM1ZmUtYzg4Ny00MjhhLWFkZmYtNTEyZTg2YmNmZmQzJTIyJTdE)
(**Writing your own notebooks**) on loop for more details.
