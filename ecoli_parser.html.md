# Directive for creating a script for your notebook


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

# Libraries

Include all the libraries which should be used in this *Escherichia
coli* module, to create log the various operations to load input files,
craete datastructures, maniplate and output desired results.

``` python
# This block should never be exported. It is to have python running in the project (and not the nbs) dir, and to initiate the package using pip.
os.chdir(core.PROJECT_DIR)
```

# Functions

Necessary functins to extract *k-mer alignment (KMA tool)* results from
*.res* files to perform following steps

- Extract data
- Filter data based on gene-specific thresholds for the *template
  coverage* and *Query identity*
- Perform *OH* typing and *stx* detection based on gene-specific
  information
- Wrangle data using *pandas* dataframes creating accurate data
  structure
- Store results in either sample-specific output files or one full tsv
  file extending the original samplesheet information

### Thresholds

Defines gene-specific tresholds used to filter the input *KMA .res*
files on the columns \[*template coverage*,*Query identity*\] to
identify genes related to: - Shiga Toxin (stx1 and stx2 subtypes) -
Serotyping using O-antigens with Serotype genes (wzx,wzy,wzt,wzm) and
H-antigen using Flagellar genes (fli & fliC) - Surface adhesion for EPEC
and STEC strains with eae gene - Hemolytic toxin (ehxA)

### Logging

Defines a logging setup function used throughout the later functions to
record information and errors both to a per-sample log file.

The log file is created inside the specified log directory with a
filename based on the sample name. The log file contains detailed
messages with information of the progression, errors and warnings with
timestamps. Which is useful for tracing execution and diagnosing issues
per sample in multi-sample pipelines.

------------------------------------------------------------------------

<a
href="https://github.com/thej-ssi/ssi_analysis_result_parsers/blob/main/ssi_analysis_result_parsers/Ecoli_parser.py#L38"
target="_blank" style="float:right; font-size:smaller">source</a>

### setup_logging

>  setup_logging (log_dir:str, sample_name:str)

### Thresholds filtering & .res parsing

For each gene specified earlier, the thresholds for the template
coverage and query identity is extracted and used to filter the input
*KMA .res* file

------------------------------------------------------------------------

<a
href="https://github.com/thej-ssi/ssi_analysis_result_parsers/blob/main/ssi_analysis_result_parsers/Ecoli_parser.py#L78"
target="_blank" style="float:right; font-size:smaller">source</a>

### process_res_file

>  process_res_file (res_file_path:str)

\*Reads and filters a KMA .res file based on predefined thresholds.

Args: res_file_path (str): Path to the .res file. thresholds (Dict\[str,
List\[int\]\]): Gene-specific thresholds.

Returns: pd.DataFrame: Filtered results DataFrame.\*

------------------------------------------------------------------------

<a
href="https://github.com/thej-ssi/ssi_analysis_result_parsers/blob/main/ssi_analysis_result_parsers/Ecoli_parser.py#L61"
target="_blank" style="float:right; font-size:smaller">source</a>

### get_threshold

>  get_threshold (template_name:str, thresholds:Dict[str,List[int]])

\*Returns the coverage and identity threshold for a given gene.

Args: template_name (str): Name of the template (gene) from the .res
file. thresholds (Dict\[str, List\[int\]\]): Dictionary of gene
thresholds.

Returns: List\[int\]: A list of two integers: \[coverage_threshold,
identity_threshold\].\*

### Escherichia coli results

Defines a class to parse, summarize and export the *E. coli* gene typing
results from the filtered .res input files. It creates per-sample
logging and outputs the results either pr sample in their respective
directories with all input files or as one conjoined file extending the
input samplesheet file. The class allows for an additional column in the
final output with a more detailed and summarize gene-specific
information of the Depth,template coverage, query identity.

With the final output with verbose option having the following structure

<table>
<colgroup>
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
<col style="width: 5%" />
</colgroup>
<thead>
<tr>
<th>sample_name</th>
<th>illumina_read_files</th>
<th>nanopore_read_file</th>
<th>assembly_file</th>
<th>organism</th>
<th>variant</th>
<th>notes</th>
<th>stx</th>
<th>OH</th>
<th>wzx</th>
<th>wzy</th>
<th>wzt</th>
<th>wzm</th>
<th>eae</th>
<th>ehxA</th>
<th>Other</th>
<th>verbose</th>
</tr>
</thead>
<tbody>
</tbody>
</table>

The Serotyping results in the above structure has gene-specific
requirements.

- If *wzx* and *wzy* are the sole O-antigen genes with no conflicts
  between them, that information is used as the O-type result and stored
  in the *OH* column, otherwise the results are store in the *wzx* and
  *wzy* columns and O-type in the *OH* column remains empty
- If *wzt* and *wzm* are the sole O-antigen genes with no conflicts
  between them, that information is used as the O-type result and stored
  in the *OH* column, otherwise the results are store in the *wzt* and
  *wzm* columns and O-type in the *OH* column remains empty  
- If all O-antigen genes exist in the *KMA* results, the O-type in the
  *OH* column remains empty and all four *wzx,wzy,wzt,wzm* columns are
  filled
- If *fli* exist in the *KMA* results that information is used as the
  H-type and stored in the *OH* column. The only scenario where *fliC*
  is used to determine the H-type and stored in the *OH* column, is when
  *fli* doesnâ€™t exist.

For any potential conflict the user is referred to the additional
information stored within the *verbose* column to accurately determine
the serotypes

------------------------------------------------------------------------

<a
href="https://github.com/thej-ssi/ssi_analysis_result_parsers/blob/main/ssi_analysis_result_parsers/Ecoli_parser.py#L110"
target="_blank" style="float:right; font-size:smaller">source</a>

### EcoliResults

>  EcoliResults (results_dict:dict)

\*Object for holding and processing E. coli typing results.

This class stores summary typing data for multiple samples, provides
utilities for per-sample processing, and export results in a
tab-seperated format (.tsv).\*

### Parser

Defines the parser of the samplesheet to utilize the previously defined
and described functionality to summarizes E. coli typing results for
each sample. Outputs a TSV file or prints the results as a DataFrame,
optionally with verbose detail.

------------------------------------------------------------------------

<a
href="https://github.com/thej-ssi/ssi_analysis_result_parsers/blob/main/ssi_analysis_result_parsers/Ecoli_parser.py#L319"
target="_blank" style="float:right; font-size:smaller">source</a>

### ecoli_parser

>  ecoli_parser (samplesheet_path:pathlib.Path,
>                    output_file:pathlib.Path=None, verbose:int=1, results_base:
>                    str='examples/Results/{sample_name}/kma/{sample_name}.res')

<table>
<colgroup>
<col style="width: 6%" />
<col style="width: 25%" />
<col style="width: 34%" />
<col style="width: 34%" />
</colgroup>
<thead>
<tr>
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>samplesheet_path</td>
<td>Path</td>
<td></td>
<td>Input samplesheet</td>
</tr>
<tr>
<td>output_file</td>
<td>Path</td>
<td>None</td>
<td>Path to output</td>
</tr>
<tr>
<td>verbose</td>
<td>int</td>
<td>1</td>
<td>Verbosity,</td>
</tr>
<tr>
<td>results_base</td>
<td>str</td>
<td>examples/Results/{sample_name}/kma/{sample_name}.res</td>
<td>Path template for .res files</td>
</tr>
</tbody>
</table>

## TESTING - empirical dataset

Perform inline testing on two empirical datasets that verifies the
functionality of the EcoliResults pipeline and datawrangling depending
on the input

## TESTING - syntehtic data

Defines several scenarions of 12 samples representing syntehtic *KMA
.res* content to perform several case specific results

``` python
import os
from tempfile import TemporaryDirectory
from pathlib import Path

test_cases = [
    # sample_name, res_content, expected_oh, expected_stx, expected_eae, expected_ehxA
    ("sample1", "1__wzx__O103__X\t100\t100\t60\n2__wzy__O103__X\t100\t100\t65\n3__fliC__H2__X\t100\t100\t70", "O103;H2", "-", "-", "-"),
    ("sample2", "1__wzt__O8__X\t100\t100\t60\n2__wzm__O8__X\t100\t100\t65\n3__fliC__H10__X\t100\t100\t70\n4__stx2__stx2-a__X\t100\t100\t90\n5__eae__eae-5__X\t100\t100\t80", "O8;H10", "stx2-a", "Positive", "-"),
    ("sample3", "1__fliC__H7__X\t100\t100\t70", "-;H7", "-", "-", "-"),
    ("sample4", "bad_line\n2__wzy__O111__X\t100\t100\t70\n3__fliC__H11__X\t100\t100\t70", "-;H11", "-", "-", "-"),
    ("sample5", "", "-;-", "-", "-", "-"),
    ("sample6", "1__wzx__O157__X\t100\t100\t60\n2__wzy__O157__X\t100\t100\t65\n3__wzt__O8__X\t100\t100\t60\n4__wzm__O8__X\t100\t100\t65\n5__fli__H2__X\t100\t100\t70", "-;H2", "-", "-", "-"),
    ("sample7", "1__wzx__O157__X\t100\t100\t60\n2__wzy__O111__X\t100\t100\t65\n3__fliC__H9__X\t100\t100\t70", "-;H9", "-", "-", "-"),
    ("sample8", "1__fli__H1__X\t100\t100\t70\n2__fliC__H12__X\t100\t100\t70", "-;H1", "-", "-", "-"),
    ("sample9", "1__wzx__O157__X\t100\t100\t60\n2__wzy__O157__X\t100\t100\t65\n3__wzt__O8__X\t100\t100\t60\n4__wzm__O8__X\t100\t100\t65\n5__fliC__H10__X\t100\t100\t70\n6__fli__H2__X\t100\t100\t70\n7__stx1__stx1-a__X\t100\t100\t90\n8__stx2__stx2-d__X\t100\t100\t90\n9__stx2__stx2-a__X\t100\t100\t90\n10__eae__eae-42-5__X\t100\t100\t80\n11__ehxA__ehxA-7__X\t100\t100\t80", "-;H2", "stx1-a;stx2-a;stx2-d", "Positive", "Positive"),
    ("sample10", "1__adk__adk__X\t100\t100\t70\n2__fliC__H4__X\t100\t100\t70", "-;H4", "-", "-", "-"),
    ("sample11", "1__eae__eae-1__X\t100\t94\t70\n2__fliC__H6__X\t100\t100\t70", "-;H6", "-", "-", "-"),
    ("sample12", "1__stx1__stx1a__X\t100\t100\t80\n2__stx2__stx2c__X\t100\t100\t85\n3__fli__H21__X\t100\t100\t70", "-;H21", "stx1a;stx2c", "-", "-"),
]

for sample_name, res_content, expected_oh, expected_stx, expected_eae, expected_ehxA in test_cases:
    with TemporaryDirectory() as tmpdir:
        tmpdir = Path(tmpdir)
        os.chdir(tmpdir)

        res_dir = tmpdir / f"examples/Results/{sample_name}/kma"
        res_dir.mkdir(parents=True)
        res_file = res_dir / f"{sample_name}.res"
        res_file.write_text("#Template\tTemplate_Coverage\tQuery_Identity\tDepth\n" + res_content)

        sheet = tmpdir / "samplesheet.tsv"
        sheet.write_text(
            "sample_name\tIllumina_read_files\tNanopore_read_file\tassembly_file\torganism\tvariant\tnotes\n"
            f"{sample_name}\tread1.fastq,read2.fastq\t-\t-\tEcoli\t-\t-\n"
        )

        results = EcoliResults.from_samplesheet(sheet)
        df = results.results_df
        row = df.iloc[0]
        
        # general output and functionality test
        assert row["sample_name"] == sample_name
        
        if row["OH"] != expected_oh:
            raise AssertionError(f"\nSample: {sample_name}\nExpected OH: {expected_oh}\nActual OH: {row['OH']}")
        assert row["OH"] == expected_oh
        
        if row["stx"] != expected_stx:
            raise AssertionError(f"\nSample: {sample_name}\nExpected stx: {expected_stx}\nActual stx: {row['stx']}")
        assert row["stx"] == expected_stx

        if row["eae"] != expected_eae:
            raise AssertionError(f"\nSample: {sample_name}\nExpected eae: {expected_eae}\nActual eae: {row['eae']}")
        assert row["eae"] == expected_eae

        if row["ehxA"] != expected_ehxA:
            raise AssertionError(f"\nSample: {sample_name}\nExpected ehxA: {expected_ehxA}\nActual ehxA: {row['ehxA']}")
        assert row["ehxA"] == expected_ehxA

        # sample specific information tests
        
        # without confliciting O and H typing, the OH column should be filled and the remaining four genes empty
        if sample_name == "sample1": 
            assert row["wzx"] == "-"
            assert row["wzy"] == "-"
            assert row["wzt"] == "-"
            assert row["wzm"] == "-"
        # with conflicts the OH should remain empty and the four 'conflicting' gene information remain filled
        elif sample_name == "sample6":
            assert row["wzx"] == "O157"
            assert row["wzy"] == "O157"
            assert row["wzt"] == "O8"
            assert row["wzm"] == "O8"
        elif sample_name == "sample10":
            assert row["Other"] == "adk"

print("All 12 syntehtic E. coli sample inline tests passed.")
```

    Logging started for examples/Log/sample1_kma_fbi.log
    Processing .res file: examples/Results/sample1/kma/sample1.res
    Successfully processed sample: sample1
    Logging started for examples/Log/sample2_kma_fbi.log
    Processing .res file: examples/Results/sample2/kma/sample2.res
    Successfully processed sample: sample2
    Logging started for examples/Log/sample3_kma_fbi.log
    Processing .res file: examples/Results/sample3/kma/sample3.res
    Successfully processed sample: sample3
    Logging started for examples/Log/sample4_kma_fbi.log
    Processing .res file: examples/Results/sample4/kma/sample4.res
    Successfully processed sample: sample4
    Logging started for examples/Log/sample5_kma_fbi.log
    Processing .res file: examples/Results/sample5/kma/sample5.res
    Successfully processed sample: sample5
    Logging started for examples/Log/sample6_kma_fbi.log
    Processing .res file: examples/Results/sample6/kma/sample6.res
    Successfully processed sample: sample6
    Logging started for examples/Log/sample7_kma_fbi.log
    Processing .res file: examples/Results/sample7/kma/sample7.res
    Successfully processed sample: sample7
    Logging started for examples/Log/sample8_kma_fbi.log
    Processing .res file: examples/Results/sample8/kma/sample8.res
    Successfully processed sample: sample8
    Logging started for examples/Log/sample9_kma_fbi.log
    Processing .res file: examples/Results/sample9/kma/sample9.res
    Successfully processed sample: sample9
    Logging started for examples/Log/sample10_kma_fbi.log
    Processing .res file: examples/Results/sample10/kma/sample10.res
    Successfully processed sample: sample10
    Logging started for examples/Log/sample11_kma_fbi.log
    Processing .res file: examples/Results/sample11/kma/sample11.res
    Successfully processed sample: sample11
    Logging started for examples/Log/sample12_kma_fbi.log
    Processing .res file: examples/Results/sample12/kma/sample12.res
    Successfully processed sample: sample12
    All 12 syntehtic E. coli sample inline tests passed.

# Directive for ensuring that the code in your notebook get executed as a script

The code-block here below is required to ensure that the code in the
notebook is also transferred to the module (script), otherwise it will
just be a notebook. See [Coding in
NBdev](https://dksund.sharepoint.com/:fl:/g/contentstorage/CSP_7c761ee7-b577-4e08-8517-bc82392bf65e/ETlSfUyArSNJhX8veMI_JQ8By1aXGHzDJkhotpfpXx4mmw?e=037EwH&nav=cz0lMkZjb250ZW50c3RvcmFnZSUyRkNTUF83Yzc2MWVlNy1iNTc3LTRlMDgtODUxNy1iYzgyMzkyYmY2NWUmZD1iJTIxNXg1MmZIZTFDRTZGRjd5Q09TdjJYblkwVlNiWXFYcE1yaHVrVmZqTVJUVEE4X1VwZjhTd1JxcjRNdmFrSmh2RCZmPTAxVlVLVzVWSlpLSjZVWkFGTkVORVlLN1pQUERCRDZKSVAmYz0lMkYmYT1Mb29wQXBwJnA9JTQwZmx1aWR4JTJGbG9vcC1wYWdlLWNvbnRhaW5lciZ4PSU3QiUyMnclMjIlM0ElMjJUMFJUVUh4a2EzTjFibVF1YzJoaGNtVndiMmx1ZEM1amIyMThZaUUxZURVeVpraGxNVU5GTmtaR04zbERUMU4yTWxodVdUQldVMkpaY1Zod1RYSm9kV3RXWm1wTlVsUlVRVGhmVlhCbU9GTjNVbkZ5TkUxMllXdEthSFpFZkRBeFZsVkxWelZXU1RJMVJsaFBNalkyUlZkQ1FqTTFRVmhKVTBkRFVVcFdXa1klM0QlMjIlMkMlMjJpJTIyJTNBJTIyNzRmNzM1ZmUtYzg4Ny00MjhhLWFkZmYtNTEyZTg2YmNmZmQzJTIyJTdE)
(**Writing your own notebooks**) on loop for more details.
